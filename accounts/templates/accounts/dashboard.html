{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% block title %}Ù…ÛŒØ²Ú©Ø§Ø± Ø«Ø¨Øª Ø§Ù‡Ø¯Ø§Ù{% endblock %}
{% block content %}
    <h2 class="gradient-text">Ø³Ù„Ø§Ù… {{ request.user.first_name }} {{ request.user.last_name }}</h2>
    {% csrf_token %}

    {# --- Ø¨Ø®Ø´ Ø§Ù…ØªÛŒØ§Ø²Ø¯Ù‡ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø§Ù…Ø±ÙˆØ² (Ø³Ø§Ø¯Ù‡ Ø´Ø¯Ù‡) --- #}
    {% if subordinates %}
        <div class="container">
            <div class="card shadow rounded-4">
                <div class="card-header bg-primary text-white fs-5 fw-bold">
                    Ø«Ø¨Øª Ø§Ù…ØªÛŒØ§Ø² Ø±ÙˆØ²Ø§Ù†Ù‡ - {{ today_year }}/{{ today_month }}/{{ today_day }}
                </div>
                <div class="table-responsive" style="overflow-y: auto; max-height: 500px;">
                    <table class="table table-bordered text-center align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Ú©Ø§Ø±Ù…Ù†Ø¯</th>
                                <th>Ù‡Ø¯Ù Ø«Ø¨Øª Ø´Ø¯Ù‡</th>
                                <th>Ø§Ù…ØªÛŒØ§Ø² Ø§Ù…Ø±ÙˆØ²</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in subordinates %}
                                <tr data-employee-id="{{ item.subordinate.id }}">
                                    <td>{{ item.subordinate.first_name }} {{ item.subordinate.last_name }}</td>
                                    <td>
                                        {% if item.target.content %}
                                            {{ item.target.content }}
                                        {% else %}
                                            <span class="text-muted">Ù‡Ø¯Ù Ú©Ø§Ø±Ø¨Ø± Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</span>
                                        {% endif %}
                                    </td>
                                    <td class="score-cell">
                                        {# --- Ù…Ù†Ø·Ù‚ Ù†Ù…Ø§ÛŒØ´ Ø³Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ --- #}
                                        {% if item.subordinate.id in today_daily_scores %}
                                            <span class="text-success">âœ… Ø«Ø¨Øª Ø´Ø¯Ù‡ ({{ today_daily_scores|get_dict_value:item.subordinate.id }})</span>
                                        {% else %}
                                            {% if item.target.content %}
                                                <button class="btn btn-sm btn-outline-primary daily-score-init-btn" data-employee-id="{{ item.subordinate.id }}">ØªØ§ÛŒÛŒØ¯ Ùˆ Ø«Ø¨Øª Ø§Ù…ØªÛŒØ§Ø²</button>
                                            {% endif %}
                                            <div class="daily-score-controls" style="display: none; justify-content: center; align-items: center;">
                                                <label>
                                                    <input type="range" min="0" max="10" step="1" value="0" class="daily-score-slider">
                                                </label>
                                                <span class="score-value fw-bold ms-2">0</span>
                                                <button class="btn btn-sm btn-success daily-score-submit-btn ms-2" data-employee-id="{{ item.subordinate.id }}">Ø«Ø¨Øª</button>
                                            </div>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% endif %}

    {# --- Ø¨Ø®Ø´ supervisors Ø­Ø°Ù Ø´Ø¯ Ú†ÙˆÙ† Ø¯ÛŒÚ¯Ø± Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ Ù†Ø¯Ø§Ø±Ø¯ --- #}

    {% if should_show_missed_scores_section %}
        <div class="container">
            <div class="card shadow rounded-4">
                <div class="card-header bg-warning text-dark fs-5 fw-bold">
                    Ø«Ø¨Øª Ø§Ù…ØªÛŒØ§Ø² Ø±ÙˆØ²Ù‡Ø§ÛŒ Ú¯Ø°Ø´ØªÙ‡ (Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ Ø´Ù…Ø³ÛŒ)
                </div>
                <div style="overflow-y: auto; max-height: 400px;" class="table-responsive mb-5">
                     <table class="table table-bordered text-center align-middle" id="missed-scores-table">
                        <thead class="table-light">
                            <tr>
                                <th>ØªØ§Ø±ÛŒØ® (Ø´Ù…Ø³ÛŒ)</th>
                                <th>Ú©Ø§Ø±Ù…Ù†Ø¯</th>
                                <th>Ù‡Ø¯Ù Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø¯Ø± Ø¢Ù† Ø±ÙˆØ²</th>
                                <th>Ø«Ø¨Øª Ø§Ù…ØªÛŒØ§Ø²</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in missed_daily_scores_opportunities %}
                                <tr data-employee-id="{{ item.employee_id }}" data-score-date="{{ item.gregorian_date_to_submit }}">
                                    <td>{{ item.jalali_date_str }}</td>
                                    <td>{{ item.subordinate_name }}</td>
                                    <td>
                                        {% if item.target_content %}
                                            {{ item.target_content }}
                                        {% else %}
                                            <span class="text-muted small">Ù‡Ø¯ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø±ÙˆØ² ØªÙˆØ³Ø· Ú©Ø§Ø±Ù…Ù†Ø¯ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</span>
                                        {% endif %}
                                    </td>
                                    <td class="missed-score-cell">
                                        {% if item.target_content %}
                                            <button class="btn btn-sm btn-outline-info missed-daily-score-init-btn">Ø«Ø¨Øª Ø§Ù…ØªÛŒØ§Ø²</button>
                                            <div class="missed-daily-score-controls" style="display: none; justify-content: center; align-items: center;">
                                                <label>
                                                    <input type="range" min="0" max="10" step="1" value="0" class="missed-daily-score-slider" style="width: 100px;">
                                                </label>
                                                <span class="missed-score-value fw-bold ms-2 me-2" style="min-width: 20px;">0</span>
                                                <button class="btn btn-sm btn-primary missed-daily-score-submit-btn">Ø«Ø¨Øª</button>
                                            </div>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted">Ù…ÙˆØ±Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ù…ØªÛŒØ§Ø²Ø¯Ù‡ÛŒ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ú¯Ø°Ø´ØªÙ‡ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                 </div>
            </div>
        </div>
    {% endif %}

    {% if not user.access_level|in_list:"0,-1" %}
        <div class="container">
            <div class="card shadow rounded-4">
                <div class="card-header bg-primary text-white fs-5 fw-bold">
                    Ø§Ù‡Ø¯Ø§Ù Ø´Ù…Ø§ Ø¯Ø± Ù…Ø§Ù‡ {{ current_month }} Ø§Ø² Ø³Ø§Ù„ {{ current_year }}
                </div>
                {% if my_scores_targets %} {# Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ† Ù†Ø§Ù… #}
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 120px;">ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª</th>
                                        <th>Ù…ØªÙ† Ù‡Ø¯Ù</th>
                                        <th>Ø§Ù…ØªÛŒØ§Ø²</th>
                                        <th>Ø²Ù…Ø§Ù† Ø«Ø¨Øª Ø§Ù…ØªÛŒØ§Ø²</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for target, score in my_scores_targets %} {# Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ† Ø­Ù„Ù‚Ù‡ #}
                                        <tr>
                                            {# target.submission_date Ø­Ø§Ù„Ø§ ÛŒÚ© Ø´ÛŒØ¡ jdatetime Ø¨Ø§ timezone Ø§Ø³Øª #}
                                            <td>{{ target.submission_date|date:"Y/m/d H:i:s" }}</td>
                                            <td>{{ target.content }}</td>
                                            {% if score %}
                                                <td>{{ score.value }}</td>
                                                {# score.created_at Ø­Ø§Ù„Ø§ ÛŒÚ© Ø´ÛŒØ¡ jdatetime Ø¨Ø§ timezone Ø§Ø³Øª #}
                                                <td>{{ score.created_at|date:"H:i:s" }}</td>
                                            {% else %}
                                                <td>Ø§Ù…ØªÛŒØ§Ø² Ø´Ù…Ø§ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</td>
                                                <td></td>
                                            {% endif %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td class="text-end fw-bold">Ù…Ø¬Ù…ÙˆØ¹</td>
                                        <td></td>
                                        <td class="fw-bold">{{ my_sum_scores }}</td> {# Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ† Ù†Ø§Ù… #}
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="text-center mt-3">
                            <p class="lead fw-bold">ØªØ¹Ø¯Ø§Ø¯ Ø§Ù‡Ø¯Ø§Ù Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§ÛŒÙ† Ù…Ø§Ù‡: {{ monthly_targets_count }}</p> {# Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ† Ù†Ø§Ù… #}
                        </div>
                    {% else %}
                        <div class="alert alert-info text-center" role="alert">
                            Ø´Ù…Ø§ ØªØ§ Ú©Ù†ÙˆÙ† Ù‡Ø¯ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø§Ù‡ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.
                        </div>
                    {% endif %}
            </div>
        </div>
    {% endif %}

    {% if users %}
        <div class="container">
        <div class="card shadow rounded-4">
            <div class="card-header bg-primary text-white fs-5 fw-bold">
                Ø§Ù…ØªÛŒØ§Ø²Ø§Øª Ù…Ø§Ù‡Ø§Ù†Ù‡ ({{ year }}/{{ month }})
            </div>
            <form method="post" id="monthlyScoreForm">
                {% csrf_token %} {# CSRF token moved inside the form #}
                <div style="max-height: 500px; overflow-y: auto;" class="table-responsive">
                    <table class="table table-bordered text-center align-middle">
                        <thead class="table-light" style="position: sticky; top: 0; z-index: 2;">
                            <tr>
                                <th>Ú©Ø§Ø±Ø¨Ø±</th>
                                <th>ØªØ­Ù‚Ù‚ Ø§Ù‡Ø¯Ø§Ù</th>
                                {% if access_level <= 2 %}<th>Ù…Ø³Ø¦ÙˆÙ„ÛŒØªâ€ŒÙ‡Ø§</th>{% endif %}
                                {% if access_level|in_list:"1,-1,0" %}<th>Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ù†Ø´</th>{% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                                <tr>
                                    <td>{{ user.first_name }} {{ user.last_name }}</td>
                                    <td>
                                        {% if 1 in existing_scores_by_user|get_dict_value:user.id %}
                                            <span class="text-success">âœ… Ø«Ø¨Øª Ø´Ø¯Ù‡ ({% get_score score_dict user.id 1 %})</span>
                                        {% else %}
                                            <div class="slider-container">
                                                <button type="button" class="slider-button slider-down" data-slider="value_{{ user.id }}_1" data-score-type="1" data-user-id="{{ user.id }}">
                                                    <i class="fas fa-circle-minus icon-remove"></i>
                                                </button>
                                                <label>
                                                    <input type="range" name="value_{{ user.id }}_1" min="0" max="100" step="1"
                                                        value="{% get_score score_dict user.id 1 %}"
                                                        data-target="{{ user.id }}" data-type="1" class="monthly-score-slider">
                                                </label>
                                                <button type="button" class="slider-button slider-up" data-slider="value_{{ user.id }}_1" data-score-type="1" data-user-id="{{ user.id }}">
                                                    <i class="fas fa-circle-plus icon-add"></i>
                                                </button>
                                                <span class="score-value fw-bold ms-2">{% get_score score_dict user.id 1 %}</span>
                                            </div>
                                        {% endif %}
                                    </td>
                                    {% if access_level <= 2 %}
                                        <td>
                                            {% if 2 in existing_scores_by_user|get_dict_value:user.id %}
                                                <span class="text-success">âœ… Ø«Ø¨Øª Ø´Ø¯Ù‡ ({% get_score score_dict user.id 2 %})</span>
                                            {% else %}
                                                <div class="slider-container">
                                                    <button type="button" class="slider-button slider-down" data-slider="value_{{ user.id }}_2" data-score-type="2" data-user-id="{{ user.id }}">
                                                          <i class="fas fa-circle-minus icon-remove"></i>
                                                    </button>
                                                    <label>
                                                        <input type="range" name="value_{{ user.id }}_2" min="0" max="100" step="1"
                                                            value="{% get_score score_dict user.id 2 %}"
                                                            data-target="{{ user.id }}" data-type="2" class="monthly-score-slider">
                                                    </label>
                                                    <button type="button" class="slider-button slider-up" data-slider="value_{{ user.id }}_2" data-score-type="2" data-user-id="{{ user.id }}">
                                                        <i class="fas fa-circle-plus icon-add"></i>
                                                    </button>
                                                    <span class="score-value fw-bold ms-2">{% get_score score_dict user.id 2 %}</span>
                                                </div>
                                            {% endif %}
                                        </td>
                                    {% endif %}
                                    {% if access_level|in_list:"1,-1,0" %}
                                        <td>
                                            {% if 3 in existing_scores_by_user|get_dict_value:user.id %}
                                                <span class="text-success">âœ… Ø«Ø¨Øª Ø´Ø¯Ù‡ ({% get_score score_dict user.id 3 %})</span>
                                            {% else %}
                                                <div class="slider-container">
                                                    <button type="button" class="slider-button slider-down" data-slider="value_{{ user.id }}_3" data-score-type="3" data-user-id="{{ user.id }}">
                                                         <i class="fas fa-circle-minus icon-remove"></i>
                                                    </button>
                                                    <label>
                                                        <input type="range" name="value_{{ user.id }}_3" min="0" max="100" step="1"
                                                            value="{% get_score score_dict user.id 3 %}"
                                                            data-target="{{ user.id }}" data-type="3" class="monthly-score-slider">
                                                    </label>
                                                    <button type="button" class="slider-button slider-up" data-slider="value_{{ user.id }}_3" data-score-type="3" data-user-id="{{ user.id }}">
                                                          <i class="fas fa-circle-plus icon-add"></i>
                                                    </button>
                                                    <span class="score-value fw-bold ms-2">{% get_score score_dict user.id 3 %}</span>
                                                </div>
                                            {% endif %}
                                        </td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                        </tbody>
                        {% if not existing_scores_by_user %}
                            <tfoot style="position: sticky; bottom: 0; background: white; z-index: 1;">
                                <tr>
                                    <td class="text-end fw-bold">Ù…Ø¬Ù…ÙˆØ¹</td>
                                    <td data-total-score-type="1" class="fw-bold">0</td>
                                    {% if access_level <= 2 %}
                                        <td data-total-score-type="2" class="fw-bold">0</td>
                                    {% endif %}
                                    {% if access_level|in_list:"1,-1,0" %}
                                        <td data-total-score-type="3" class="fw-bold">0</td>
                                    {% endif %}
                                </tr>
                            </tfoot>
                        {% endif %}
                    </table>
                </div>
{#            TODO: Change here to disable button #}
                {% if not existing_scores_by_user %}
                    {% if users %}
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-success px-4">ğŸ’¾ Ø«Ø¨Øª Ø§Ù…ØªÛŒØ§Ø² Ù…Ø§Ù‡Ø§Ù†Ù‡</button>
                        </div>
                    {% else %}
                        <strong class="text-danger-emphasis">Ø¨Ø§ ØªÙˆØ¬Ù‡ Ø¨Ù‡ ØªØ§Ø±ÛŒØ® ÙˆØ±ÙˆØ¯ Ø´Ù…Ø§ Ø¨Ù‡ Ø´Ø±Ú©ØªØŒ Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø§Ù‡ Ù…Ø¬Ø§Ø² Ø¨Ù‡ Ø«Ø¨Øª Ø§Ù…ØªÛŒØ§Ø² Ù†ÛŒØ³ØªÛŒØ¯!</strong>
                    {% endif %}
                {% endif %}
            </form>
        </div>
    </div>
    {% else %}
        {# TODO: showing hint message #}
    {% endif %}
    <style>
        .container {
            margin-top: 2rem;
        }
        .icon-remove {
            transition: transform 0.3s ease, fill 0.3s ease;
            cursor: pointer;
        }
        .icon-remove:active {
            transform: scale(1.2) rotate(-15deg);
            fill: #FFD6D6;
        }
        .icon-add {
            transition: transform 0.3s ease, fill 0.3s ease;
            cursor: pointer;
        }
        .icon-add:active {
            transform: rotate(90deg) scale(1.2);
            fill: #C8FAD2;
        }
        #table-responsive, .table-responsive {
            max-height: 500px;
            overflow-y: auto;
        }
        .table-responsive table td {
            font-size: 0.9rem;
        }
        {#.total-exceeded {#}
        {#    color: red;#}
        {#    font-weight: bolder;#}
        {#{ #}

        .slider-container {
            display: flex;
            align-items: center;
            justify-content: center; /* Added to center the controls */
        }

        .slider-button {
            background-color: transparent;
            border: none;
            padding: 5px;
            cursor: pointer;
            margin: 0 5px;
            transition: color 0.3s ease;
            font-size: 1.2em;
            color: #555;
            display: flex; /* Use flex to center the icon */
            align-items: center; /* Center the icon vertically */
            justify-content: center; /* Center the icon horizontally */
        }

        .slider-button:hover {
            color: #007bff;
        }

        .slider-button:active {
            color: #0056b3;
        }
        
        .slider-button:disabled {
            color: #aaa;
            cursor: not-allowed;
        }

        .slider-button:disabled:hover {
            color: #aaa;
        }
        .slider-button i {
            display: inline-block;
        }
         .score-value {
            min-width: 30px; /* Give the score span a fixed width to prevent layout shifts */
            text-align: center; /* Center the score text */
        }
    </style>

    <script>
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const monthlyScoreSliders = document.querySelectorAll(".monthly-score-slider");
        const monthlyScoreForm = document.getElementById("monthlyScoreForm");
        // Pass access_level from Django context to JavaScript, safely handling None
        const userAccessLevel = {{ user.access_level|default:"null"|safe }};
    
        // Function to update the displayed score and button states for a single slider
        function updateSliderDisplayAndButtons(slider) {
            const sliderContainer = slider.closest('.slider-container');
            if (!sliderContainer) return; // Exit if container not found

            const scoreValueSpan = sliderContainer.querySelector('.score-value');
            const upButton = sliderContainer.querySelector('.slider-button.slider-up');
            const downButton = sliderContainer.querySelector('.slider-button.slider-down');
            const currentValue = parseInt(slider.value);
            const max = parseInt(slider.max);
            const min = parseInt(slider.min);

            if (scoreValueSpan) {
                scoreValueSpan.innerText = currentValue;
            }

            if (upButton) {
                upButton.disabled = currentValue >= max;
            }

            if (downButton) {
                downButton.disabled = currentValue <= min;
            }
        }

        function handleMonthlySliderInput(event) {
            const changedSlider = event.target;
            const scoreType = changedSlider.dataset.type;
            updateSliderDisplayAndButtons(changedSlider); // Update display and buttons for the changed slider
            updateMonthlyColumnTotalAndMaxes(scoreType);
        }

        function updateMonthlyColumnTotalAndMaxes(scoreType) {
            const slidersInColumn = document.querySelectorAll(`.monthly-score-slider[data-type="${scoreType}"]`);
            let currentTotal = 0;
            slidersInColumn.forEach(slider => {
                currentTotal += parseInt(slider.value);
            });

            const totalDisplayElement = document.querySelector(`[data-total-score-type="${scoreType}"]`);
            if (totalDisplayElement) {
                totalDisplayElement.innerText = currentTotal;
                if (currentTotal > 100) {
                    totalDisplayElement.classList.add('total-exceeded');
                } else {
                    totalDisplayElement.classList.remove('total-exceeded');
                }
            }

            // Recalculate and update max for all sliders in the column
            slidersInColumn.forEach(slider => {
                const sliderCurrentValue = parseInt(slider.value);
                // The calculation for newMax was correct, no change needed here.
                let newMax = sliderCurrentValue + (100 - currentTotal);
                newMax = Math.min(100, newMax);
                newMax = Math.max(sliderCurrentValue, newMax);
                slider.max = newMax;
                 // After updating max, update the display and button states for this slider
                updateSliderDisplayAndButtons(slider);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (monthlyScoreForm) {
                monthlyScoreSliders.forEach(slider => {
                    slider.addEventListener("input", handleMonthlySliderInput);
                    // Initial update of display and buttons on page load
                    updateSliderDisplayAndButtons(slider);
                    console.log(`Monthly Slider Initial Value - User: ${slider.dataset.target}, Type: ${slider.dataset.type}, Value: ${slider.value}`);
                });

                const monthlyScoreTypes = new Set();
                monthlyScoreSliders.forEach(slider => {
                    monthlyScoreTypes.add(slider.dataset.type);
                });

                monthlyScoreTypes.forEach(scoreType => {
                    updateMonthlyColumnTotalAndMaxes(scoreType);
                });
            }

            document.querySelectorAll(".missed-daily-score-init-btn").forEach(button => {
            button.addEventListener("click", function() {
                const row = this.closest('tr');
                const controlsContainer = row.querySelector('.missed-daily-score-controls');
                this.style.display = 'none'; // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ "Ø«Ø¨Øª Ø§Ù…ØªÛŒØ§Ø²"
                if (controlsContainer) {
                    controlsContainer.style.display = 'flex'; // Ù†Ù…Ø§ÛŒØ´ Ø§Ø³Ù„Ø§ÛŒØ¯Ø± Ùˆ Ø¯Ú©Ù…Ù‡ Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ
                    const slider = controlsContainer.querySelector('.missed-daily-score-slider');
                    const valueSpan = controlsContainer.querySelector('.missed-score-value');
                    if (slider && valueSpan) {
                        valueSpan.innerText = slider.value; // Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ø§Ø³Ù„Ø§ÛŒØ¯Ø± Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
                    }
                }
            });
        });

        document.querySelectorAll(".missed-daily-score-slider").forEach(slider => {
            slider.addEventListener("input", function() {
                const valueSpan = this.closest('.missed-daily-score-controls').querySelector('.missed-score-value');
                if (valueSpan) {
                    valueSpan.innerText = this.value; // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù…Ù‚Ø¯Ø§Ø± Ø§Ø³Ù„Ø§ÛŒØ¯Ø±
                }
            });
        });

        document.querySelectorAll(".missed-daily-score-submit-btn").forEach(button => {
            button.addEventListener("click", function() {
                const submitButton = this; // Ø¯Ú©Ù…Ù‡ Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ú©Ù„ÛŒÚ© Ø´Ø¯Ù‡
                const row = submitButton.closest('tr');
                const employeeId = row.dataset.employeeId;
                // `data-score-date` Ø­Ø§ÙˆÛŒ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ YYYY-MM-DD Ø§Ø³Øª
                const scoreDateForSubmission = row.dataset.scoreDate; 
                const controlsContainer = submitButton.closest('.missed-daily-score-controls');
                const slider = controlsContainer.querySelector('.missed-daily-score-slider');
                const scoreValue = parseInt(slider.value);
                const initialButton = row.querySelector('.missed-daily-score-init-btn');

                // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©Ù„ÛŒÚ©â€ŒÙ‡Ø§ÛŒ Ù…ØªØ¹Ø¯Ø¯
                submitButton.disabled = true;
                slider.disabled = true;
                if (initialButton) initialButton.disabled = true; 

                fetch("{% url 'submit_daily_score' %}", { // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù‡Ù…Ø§Ù† URL Ù‚Ø¨Ù„ÛŒ
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrftoken // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ØªØ¹Ø±ÛŒÙ csrftoken Ø¯Ø± Ø§Ø³Ú©ÙˆÙ¾
                    },
                    body: JSON.stringify({
                        employee_id: employeeId,
                        value: scoreValue,
                        score_date: scoreDateForSubmission // +++ Ø§Ø±Ø³Ø§Ù„ ØªØ§Ø±ÛŒØ® Ù…Ø´Ø®Øµ Ø§Ù…ØªÛŒØ§Ø² +++
                    })
                })
                .then(response => response.json())
                .then(data => {
                    const scoreCell = row.querySelector('.missed-score-cell');
                    if (data.status === "ok") {
                        if (controlsContainer) controlsContainer.style.display = 'none'; // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§
                        let successMsg = `âœ… Ø«Ø¨Øª Ø´Ø¯ (${scoreValue})`;
                        if (data.message) { // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù¾ÛŒØ§Ù… Ø³Ø±ÙˆØ± Ú©Ù‡ Ø­Ø§ÙˆÛŒ ØªØ§Ø±ÛŒØ® Ø§Ø³Øª
                            successMsg = `âœ… ${data.message.replace("Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ® ", "").replace(" Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯.", ` (${scoreValue})`)}`;
                        }
                        scoreCell.innerHTML = `<span class="text-success">${successMsg}</span>`;
                        alert(data.message || `Ø§Ù…ØªÛŒØ§Ø² (${scoreValue}) Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ® ${scoreDateForSubmission} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯.`);
                    } else {
                        let errorMessage = `âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ® ${scoreDateForSubmission}.`;
                        if (data.error) {
                            errorMessage += "\n" + data.error;
                        }
                        alert(errorMessage);
                        // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù…Ø¬Ø¯Ø¯ Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§
                        submitButton.disabled = false;
                        slider.disabled = false;
                        if (initialButton) initialButton.disabled = false;
                    }
                })
                .catch(error => {
                    console.error("Error submitting missed daily score:", error);
                    alert(`âŒ Ø®Ø·Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ù‡Ù†Ú¯Ø§Ù… Ø«Ø¨Øª Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø±Ø§ÛŒ ${scoreDateForSubmission}.`);
                    // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù…Ø¬Ø¯Ø¯ Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡
                    submitButton.disabled = false;
                    slider.disabled = false;
                    if (initialButton) initialButton.disabled = false;
                });
            });
        });

            // Initial setup for daily score sliders on page load
            document.querySelectorAll(".daily-score-slider").forEach(slider => {
                 const dailyScoreControls = slider.closest('.daily-score-controls');
                 if (dailyScoreControls) {
                     const scoreValueSpan = dailyScoreControls.querySelector('.score-value');
                     if (scoreValueSpan) {
                         scoreValueSpan.innerText = slider.value;
                     }
                 }
            });
        });

        if (monthlyScoreForm) {
            monthlyScoreForm.addEventListener("submit", function(event) {
                event.preventDefault();
                const confirmationMessage = "âš ï¸ Ù¾Ø³ Ø§Ø² Ø«Ø¨Øª Ø§Ù…ØªÛŒØ§Ø²Ø§Øª Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø§Ù‡ØŒ Ø¯ÛŒÚ¯Ø± Ù‚Ø§Ø¯Ø± Ø¨Ù‡ Ø§ÛŒØ¬Ø§Ø¯ ØªØºÛŒÛŒØ±Ø§Øª Ù†Ø®ÙˆØ§Ù‡ÛŒØ¯ Ø¨ÙˆØ¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø­Ø§ØµÙ„ Ú©Ù†ÛŒØ¯ Ú©Ù‡ ØªÙ…Ø§Ù… Ø§Ù…ØªÛŒØ§Ø²Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø±Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯ Ùˆ Ø¨Ø§Ø²Ø¨ÛŒÙ†ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒØ¯.\n\nØ¢ÛŒØ§ Ø§Ø² Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ";

                if (!confirm(confirmationMessage)) {
                    return;
                }

                const monthlyScoreTypes = new Set();
                monthlyScoreSliders.forEach(slider => {
                    monthlyScoreTypes.add(slider.dataset.type);
                });

                let hasError = false;
                monthlyScoreTypes.forEach(scoreType => {
                    const slidersInColumn = document.querySelectorAll(`.monthly-score-slider[data-type="${scoreType}"]`);
                    let total = 0;
                    slidersInColumn.forEach(slider => {
                        total += parseInt(slider.value);
                    });
                    if (total > 100) {
                        {#const totalDisplayElement = document.querySelector(`[data-total-score-type="${scoreType}"]`);#}
                        let columnHeader = `Ù†ÙˆØ¹ ${scoreType}`;
                        try {
                            const headerRow = document.querySelector('thead tr');
                            const headerCells = headerRow.cells;

                            // Correctly determine column header based on scoreType and userAccessLevel
                            if (scoreType === '1' && headerCells.length > 1) {
                                columnHeader = headerCells[1].innerText;
                            } else if (scoreType === '2' && userAccessLevel !== null && userAccessLevel <= 2 && headerCells.length > 2) {
                                columnHeader = headerCells[2].innerText;
                            } else if (scoreType === '3' && userAccessLevel !== null && (userAccessLevel === 1 || userAccessLevel === 0 || userAccessLevel === -1) && headerCells.length > (userAccessLevel !== null && userAccessLevel <= 2 ? 3 : 2)) {
                                // Column 3 is the 3rd or 4th header cell depending on if column 2 is present
                                columnHeader = headerCells[headerCells.length - 1].innerText;
                            } else {
                                console.warn(`Could not reliably find header for score type ${scoreType}, using default.`);
                            }

                        } catch (e) {
                            console.error("Could not find column header:", e);
                        }
                        alert(`âŒ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª Ø¨Ø±Ø§ÛŒ "${columnHeader.trim()}" (${total}) Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² Û±Û°Û° Ø¨Ø§Ø´Ø¯.`);
                        hasError = true;
                    }
                });

                if (hasError) {
                    return;
                }

                const data = [];
                monthlyScoreSliders.forEach(slider => {
                    const target_id = slider.dataset.target;
                    const score_type = slider.dataset.type;
                    const value = parseInt(slider.value);
                    data.push({ target_id: target_id, score_type: score_type, value: value });
                });

                fetch("{% url 'update_monthly_scores' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrftoken
                    },
                    body: JSON.stringify({ scores: data })
                })
                .then(res => res.json())
                .then(res => {
                    if (res.status === "ok") {
                        alert("âœ… Ø§Ù…ØªÛŒØ§Ø²Ù‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†Ø¯.");
                        window.location.reload();
                    }
                    else {
                        let errorMessage = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ù…ØªÛŒØ§Ø²Ù‡Ø§.";
                        if (res.error) {
                            errorMessage += "\n" + res.error;
                        }
                        alert(errorMessage);
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("âŒ Ø®Ø·Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ø±Ø® Ø¯Ø§Ø¯.");
                });
            });
        }

        document.querySelectorAll(".daily-score-init-btn").forEach(button => {
            button.addEventListener("click", function() {
                const row = this.closest('tr');
                const controlsContainer = row.querySelector('.daily-score-controls');
                this.style.display = 'none';
                controlsContainer.style.display = 'flex';
                const slider = controlsContainer.querySelector('.daily-score-slider');
                const valueSpan = controlsContainer.querySelector('.score-value');
                valueSpan.innerText = slider.value;
            });
        });

        document.querySelectorAll(".daily-score-slider").forEach(slider => {
            slider.addEventListener("input", function() {
                const valueSpan = this.closest('.daily-score-controls').querySelector('.score-value');
                if (valueSpan) {
                    valueSpan.innerText = this.value;
                }
            });
        });

        document.querySelectorAll(".daily-score-submit-btn").forEach(button => {
            button.addEventListener("click", function() {
                const row = this.closest('tr');
                const employeeId = row.dataset.employeeId;
                const controlsContainer = this.closest('.daily-score-controls');
                const slider = controlsContainer.querySelector('.daily-score-slider');
                const scoreValue = parseInt(slider.value);
                this.disabled = true;
                slider.disabled = true;
                const initialButton = row.querySelector('.daily-score-init-btn');
                if (initialButton) initialButton.disabled = true;

                fetch("{% url 'submit_daily_score' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrftoken
                    },
                    body: JSON.stringify({ employee_id: employeeId, value: scoreValue })
                })
                .then(res => res.json())
                .then(res => {
                    const scoreCell = row.querySelector('.score-cell');
                    if (res.status === "ok") {
                        controlsContainer.style.display = 'none';
                        scoreCell.innerHTML = `<span class="text-success">âœ… Ø«Ø¨Øª Ø´Ø¯Ù‡ (${scoreValue})</span>`;
                        alert("âœ… Ø§Ù…ØªÛŒØ§Ø² Ø±ÙˆØ²Ø§Ù†Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯.");
                    } else if (res.status === "duplicate") {
                        alert("âš ï¸ Ø´Ù…Ø§ Ø§Ù…Ø±ÙˆØ² Ù‚Ø¨Ù„Ø§Ù‹ Ø¨Ù‡ Ø§ÛŒÙ† Ú©Ø§Ø±Ù…Ù†Ø¯ Ø§Ù…ØªÛŒØ§Ø² Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒØ¯.");
                        controlsContainer.style.display = 'none';
                        scoreCell.innerHTML = '<span class="text-success">âœ… Ø«Ø¨Øª Ø´Ø¯Ù‡</span>';
                    } else {
                        let errorMessage = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ù…ØªÛŒØ§Ø² Ø±ÙˆØ²Ø§Ù†Ù‡.";
                        if (res.error) {
                            errorMessage += "\n" + res.error;
                        }
                        alert(errorMessage);
                        this.disabled = false;
                        slider.disabled = false;
                        if (initialButton) initialButton.disabled = false;
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("âŒ Ø®Ø·Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ø±Ø® Ø¯Ø§Ø¯.");
                    this.disabled = false;
                    slider.disabled = false;
                    if (initialButton) initialButton.disabled = false;
                });
            });
        });
        // Add event listeners to the up and down buttons for the monthly sliders
        document.querySelectorAll(".slider-button").forEach(button => {
            button.addEventListener("click", function() {
                const sliderId = this.dataset.slider;
                const slider = document.querySelector(`input[name="${sliderId}"]`);
                let currentValue = parseInt(slider.value.toString());
                {#const scoreType = this.dataset.scoreType;#}
                {#const userId = this.dataset.userId;#}

                if (this.classList.contains('slider-up')) {
                    currentValue = Math.min(currentValue + 1, parseInt(slider.max)); // Use slider.max here
                } else {
                    currentValue = Math.max(currentValue - 1, parseInt(slider.min)); // Use slider.min here
                }

                slider.value = currentValue;

                // Trigger the input event manually to update the display and total
                const inputEvent = new Event('input', { bubbles: true });
                slider.dispatchEvent(inputEvent);
            });
        });
    </script>
{% endblock %}