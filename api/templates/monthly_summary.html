{# ุฏุฑ ูุงู ุชููพูุช monthly_scores_summary.html #}
{% extends 'base.html' %}
{% load static %} {# ุจุฑุง ููุฏ ูุงู ูุง static #}
{% load custom_filters %} {# ุงฺฏุฑ ููุชุฑูุง ุณูุงุฑุด ุฏุงุฑุฏ #}

{% block title %}ุฎูุงุตู ุงูุชุงุฒุงุช ูุงูุงูู{% endblock %}

{% block content %}
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="copyToast" class="toast text-white bg-success border-0" role="alert" data-bs-delay="1500">
            <div class="d-flex">
            <div class="toast-body">
                ฺฉูพ ุดุฏ โ
            </div>
            </div>
        </div>
    </div>
    <div class="container mt-4">
        <div class="mb-4 text-center" style="display: flex; align-items: center; justify-content: center; gap: 10px;">
            <i class="fa-solid fa-chart-line" style="font-size: 28px; color: #418007;"></i>
            <h1 style="margin: 0;">ุฎูุงุตู ุงูุชุงุฒุงุช ูุงูุงูู ฺฉุงุฑุจุฑุงู</h1>
        </div>
            {% if error_message %}
                <div class="alert alert-danger" role="alert">
                    {{ error_message }}
                 </div>
            {% endif %}

             {% if summary_data %}
                       <div class="mb-4">
                            {% if summary_data.user_summaries %}
                                <a href="?year={{ summary_data.jdate.0 }}&month={{ summary_data.jdate.1 }}&export=excel" class="btn btn-outline-success">
                                    <i class="fas fa-file-excel me-2"></i> ุจุงุฑฺฏุฑ ูุงู ุงฺฉุณู
                                </a>
                            {% else %}
                                <div class="m-5">
                                    <h5 class="text-muted">๐ญ  ูุชุงุณูุงูู ุฏุงุฏู ุง ุจุฑุง ูุงู {{ summary_data.jdate.1 }} ุงุฒ ุณุงู {{ summary_data.jdate.0 }} ุงูุช ูุดุฏ!</h5>
                                </div>
                            {% endif %}

                        </div>
                         <div class="mb-4">
                               <form method="get" class="row g-3 justify-content-center mb-4">
                                    <div class="col-auto">
                                        <label>
                                            <input type="number" name="year" class="form-control" placeholder="ุณุงู ุดูุณ" value="{{ summary_data.jdate.0 }}">
                                        </label>
                                    </div>
                                    <div class="col-auto">
                                        <label>
                                            <input type="number" name="month" class="form-control" placeholder="ูุงู" value="{{ summary_data.jdate.1 }}">
                                        </label>
                                    </div>
                                    <div class="col-auto">
                                        <button type="submit" class="btn btn-primary">ููุงุด</button>
                                    </div>
                               </form>
                         </div>

                        {# ุจุฎุด ุขูุงุฑ ฺฉู ุจุฑ ุงุณุงุณ ุณุทุญ ุฏุณุชุฑุณ #}
            <div class="card mb-4">
                <div class="card-header">
                    <h5>ุขูุงุฑ ฺฉู ุจุฑ ุงุณุงุณ ุณุทุญ ุฏุณุชุฑุณ</h5>
                </div>
                <div class="card-body table-responsive">
                    <table class="table table-bordered table-striped mb-0">
                        <thead>
                            <tr>
                                <th>ุณุทุญ ุฏุณุชุฑุณ</th>
                                <th>ุชุนุฏุงุฏ ฺฉุงุฑุจุฑุงู (ุจุง ุงูุชุงุฒ)</th> {# ุชุนุฏุงุฏ ฺฉุงุฑุจุฑุงู ฺฉู ุฏุฑ ุงู ูุงู ุงูุชุงุฒ ุฏุฑุงูุช ฺฉุฑุฏูโุงูุฏ #}
                                <th>ุงูุชุงุฒ ูุฏุงุฏู ุงูุฏ</th> {# ุชุนุฏุงุฏ ฺฉุงุฑุจุฑุงู ฺฉู ุจุงุฏ ุงูุชุงุฒ ู ุฏุงุฏูุฏ ูู ูุฏุงุฏู ุงูุฏ #}
                                <th>ูุฌููุน ุงูุชุงุฒ ูุญุงุณุจู ุดุฏู ฺฉู</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for level_stats, no_score_givers in summary_data.overall_stats_by_access_level %}
                                <tr>
                                    <td>{{ level_stats.name }}</td>
                                    <td>{{ level_stats.count }}</td>
                                    <td>{{ no_score_givers.0.count|default:"0" }}</td>
                                    <td>{{ level_stats.total_score_sum }}</td>
                                </tr>
                            {% endfor %}
                            <tr>
                                <td>
                                    <strong>ูุฌููุน</strong>
                                </td>
                                <td class="text-primary fw-bold copyable" style="cursor: pointer;">
                                    {{ summary_data.overall_stats_by_access_level.0.0.sum }}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
                        {# ุจุฎุด ุขูุงุฑ ฺฉู ุจุฑ ุงุณุงุณ ฺฉุงุฑุจุฑุงู ฺฉู ุงูุชุงุฒ ูุฏุงุฏู ุงูุฏ #}
            <div class="card mb-4">
                <div class="card-header">
                    <h5>ุขูุงุฑ ฺฉู ุจุฑ ุงุณุงุณ ฺฉุงุฑุจุฑุงู ฺฉู ุงูุชุงุฒ ูุฏุงุฏู ุงูุฏ</h5>
                </div>
                <div class="card-body">
                    <div style="max-height: 300px; overflow-y: auto;"> {# ุงุฑุชูุงุน ุซุงุจุช ุจุฑุง ุงุณฺฉุฑูู ุฏุฑ ุตูุฑุช ุทููุงู ุดุฏู ูุณุช #}
                        <table class="table table-bordered table-striped mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 50px;">ุฑุฏู</th>
                                    <th>ูุงู</th>
                                    <th>ููุน ฺฉุงุฑุจุฑ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in summary_data.no_score_givers_users %}
                                        <tr>
                                            <td>{{ forloop.counter }}</td>
                                            <td>{{ user.first_name }} {{ user.last_name }}</td>
                                            <td>
                                                {% if user.access_level == 1 %}ูุฏุฑ ูุงู
                                                {% elif user.access_level == 2 %}ฺฉุงุฑููุฏ ุจุฑุชุฑ
                                                {% elif user.access_level == 3 %}ฺฉุงุฑููุฏ ุนุงุฏ
                                                {% elif user.access_level == -1 %} ูุฆุช ูุฏุฑู (ูุฏุฑ ูุงู)
                                                {% else %}ุณุทุญ {{ user.access_level }}
                                                {% endif %}
                                            </td>
                                        </tr>
                                {% endfor %}
                                {% comment %} ุงฺฏุฑ ูุณุช no_score_givers_users ุฎุงู ุจุงุดุฏ ู ุจู ุตูุฑุช zip ุดุฏู ุจุง count ุงุฑุณุงู ุดุฏู ุจุงุดุฏุ ุงู ุจุฎุด ููฺฉู ุงุณุช ูุงุฒ ุจู ุจุงุฒูฺฏุฑ ุฏุงุดุชู ุจุงุดุฏ {% endcomment %}
                                {% if not summary_data.no_score_givers_users %}
                                    <tr>
                                        <td colspan="3" class="text-center">ููู ฺฉุงุฑุจุฑุงู ุงูุชุงุฒ ูุงูุงูู ุฎูุฏ ุฑุง ุซุจุช ฺฉุฑุฏูโุงูุฏ ุง ุณุทูุญ ุฏุณุชุฑุณ ูุฑุชุจุท (ฑุ ฒุ ณ) ูุฌูุฏ ูุฏุงุฑุฏ.</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>


                        {# ุจุฎุด ุฎูุงุตู ุงูุชุงุฒุงุช ูุฑ ฺฉุงุฑุจุฑ #}
            <div class="card mb-4">
                <div class="card-header">
                    <h5>ุฎูุงุตู ุงูุชุงุฒุงุช ูุฑ ฺฉุงุฑุจุฑ</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;"> {# ุจุฑุง ููุงุด ุจูุชุฑ ุฏุฑ ุตูุญู ูุง ฺฉูฺฺฉ #}
                        <table class="table table-bordered table-striped mb-0">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">ุฑุฏู</th>
                                    <th>ฺฉุงุฑุจุฑ</th>
                                    <th>ุณุทุญ ุฏุณุชุฑุณ</th>
                                    <th>ุงูุชุงุฒุงุช ุจุฑ ุงุณุงุณ ููุน</th>
                                    <th>ูุฌููุน ุงูุชุงุฒ ูุญุงุณุจู ุดุฏู</th> {# ุณุชูู ุงุตู ุงูุชุงุฒ ูุญุงุณุจู ุดุฏู #}
                                    {# --- ุณุชูู ุฌุฏุฏ ุจุฑุง ุชูุธู ูุฆุช ูุฏุฑู --- #}
                                    {% if request.user.access_level == -1 %} {# ููุท ุจุฑุง ูุฆุช ูุฏุฑู ููุงุด ุฏุงุฏู ุดูุฏ #}
                                    <th>ุชูุธู ูุฆุช ูุฏุฑู</th>
                                    <th>ูุฌููุน ููุง ุงูุชุงุฒ</th> {# ุณุชูู ุฌุฏุฏ ุจุฑุง ูุฌููุน ุจุง ุชูุธู #}
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for user_summary in summary_data.user_summaries %}
                                    <tr data-user-id="{{ user_summary.user.id }}"> {# ุงุถุงูู ฺฉุฑุฏู data-user-id ุจุฑุง ุฌุงูุงุงุณฺฉุฑูพุช #}
                                        <td>{{forloop.counter}}</td>
                                        <td>{{ user_summary.user.first_name }} {{ user_summary.user.last_name }}</td>
                                        <td>
                                            {% if user_summary.access_level == 1 %}ูุฏุฑ ูุงู
                                            {% elif user_summary.access_level == 2 %}ฺฉุงุฑููุฏ ุจุฑุชุฑ
                                            {% elif user_summary.access_level == 3 %}ฺฉุงุฑููุฏ ุนุงุฏ
                                            {% else %}ุณุทุญ {{ user_summary.access_level }}
                                            {% endif %}
                                        </td>
                                        <td> {# ุณุชูู ุงูุชุงุฒุงุช ุจุฑ ุงุณุงุณ ููุน #}
                                            <ul>
                                                {% for score_type, score_value in user_summary.scores_by_type.items %}
                                                <li>
                                                    {% if score_type == "1" %}ุชุญูู ุงูุฏุงู
                                                    {% elif score_type == "2" %}ูุณุฆููุช ูุง
                                                    {% else %}ูุฏุฑุช ุฏุงูุด
                                                    {% endif %}
                                                    : {{ score_value }}
                                                </li>
                                                {% empty %}
                                                    <li>ุจุฏูู ุงูุชุงุฒ ุฏุฑ ุงู ูุงู</li>
                                                {% endfor %}
                                            </ul>
                                        </td>
                                        <td class="total-monthly-score">{{ user_summary.total_monthly_score }}</td> {# ุณุชูู ุงูุชุงุฒ ูุญุงุณุจู ุดุฏู #}

                                        {# --- ุณููู ูุง ุฌุฏุฏ ุจุฑุง ุชูุธู ูุฆุช ูุฏุฑู --- #}
                                        {% if request.user.access_level == -1 %}
                                        <td class="board-adjustment-cell">
                                            <div class="d-flex justify-content-center align-items-center"> {# ุงุณุชูุงุฏู ุงุฒ ููฺฉุณ ุจุฑุง ฺฉูุงุฑ ูู ูุฑุงุฑ ุฏุงุฏู ุฏฺฉูู ู ุนุฏุฏ #}
                                                <button class="btn btn-sm btn-outline-secondary adjust-score-btn me-2" data-delta="1" title="ุงูุฒุงุด ุงูุชุงุฒ ุชูุธู ุดุฏู">+</button> {# ฺฉูุงุณูุง ุจูุช ุงุณุชุฑูพ ู ูุงุตูู #}
                                                <span class="board-adjustment-value fw-bold" style="min-width: 40px; text-align: center;">{{ user_summary.board_adjustment|floatformat:0|default:"0" }}</span>
                                                <button class="btn btn-sm btn-outline-secondary adjust-score-btn ms-2" data-delta="-1" title="ฺฉุงูุด ุงูุชุงุฒ ุชูุธู ุดุฏู">-</button> {# ฺฉูุงุณูุง ุจูุช ุงุณุชุฑูพ ู ูุงุตูู #}
                                            </div>
                                        </td>
                                        <td class="total-monthly-score-adjusted fw-bold">{{ user_summary.total_monthly_score_adjusted|default:"0.000" }}</td> {# ุณุชูู ูุฌููุน ููุง ุจุง ุชูุธู #}
                                        {% endif %}
                                    </tr>
                                {% empty %} {# ุงฺฏุฑ ูุณุช user_summaries ุฎุงู ุจุงุดุฏ #}
                                    <tr>
                                        <td colspan="{% if request.user.access_level == -1 %}7{% else %}5{% endif %}" class="text-center">ุฏุงุฏู ุงูุชุงุฒ ูุงูุงูู ุจุฑุง ููุงุด ูุฌูุฏ ูุฏุงุฑุฏ.</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>


              {% elif summary_data is None and not error_message %}
                        <div class="alert alert-info" role="alert">
                                  ุฏุงุฏูโุง ุจุฑุง ููุงุด ูุฌูุฏ ูุฏุงุฑุฏ ุง ุฎุทุง ุฏุฑ ูุงฺฉุด ุฏุงุฏูโูุง ุฑุฎ ุฏุงุฏู ุงุณุช.
                        </div>
              {% endif %}
    </div>
{% endblock %}

{% block extra_js %}
    <script src="{% static 'scripts/decimal.min.js' %}"></script> {# ูุทูุฆู ุดูุฏ ูุณุฑ ุตุญุญ ุงุณุช #}
    <script>
    document.addEventListener('DOMContentLoaded', function() {

    const toastElement = document.getElementById('copyToast');
    const toast = new bootstrap.Toast(toastElement);

    document.querySelectorAll(".copyable").forEach(function (el) {
        el.addEventListener("click", function () {
            const text = this.textContent.trim();

            // ุชูุงุด ุจุฑุง ฺฉูพ ุจุง ุฑูุด ุงูู
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    toast.show();
                }).catch(() => alert("ุฎุทุง ุฏุฑ ฺฉูพ โ"));
            } else {
                // fallback ุจุฑุง ูุฑูุฑฺฏุฑูุง ฺฉู clipboard ูุฏุงุฑู
                const textarea = document.createElement("textarea");
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand("copy");
                    toast.show();
                } catch (err) {
                    alert("ุฎุทุง ุฏุฑ ฺฉูพ โ");
                }
                document.body.removeChild(textarea);
            }
        });
    });
    // ุฏุฑุงูุช CSRF token
    const getCookie = (name) => {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrfToken = getCookie('csrftoken'); // ุฏุฑุงูุช ุงุฒ ฺฉูฺฉ

    const adjustButtons = document.querySelectorAll('.adjust-score-btn');

    // ** ุงุถุงูู ฺฉุฑุฏู ุงู ุฏู ุฎุท ุจุฑุง ุฏุฑุงูุช ุณุงู ู ูุงู ุฌุงุฑ ุงุฒ ุฎูุงุตู ุฏุงุฏูโูุง **
    const currentYear = {{ summary_data.jdate.0 }};
    const currentMonth = {{ summary_data.jdate.1 }};

    adjustButtons.forEach(button => {
        button.addEventListener('click', function() {
            const row = this.closest('tr');
            const userId = row.dataset.userId;
            const delta = parseFloat(this.dataset.delta);

            if (!userId || isNaN(delta)) {
                console.error("Missing or invalid user ID or delta");
                alert("ุฎุทุง ุฏุฑ ุงุทูุงุนุงุช ุฏฺฉูู ุง ฺฉุงุฑุจุฑ.");
                return;
            }

            const adjustmentCell = this.closest('.board-adjustment-cell');
            const buttonsInCell = adjustmentCell.querySelectorAll('.adjust-score-btn');
            buttonsInCell.forEach(btn => btn.disabled = true);

            const url = "{% url 'monthlyscores-adjust-board-score' %}";

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({
                    user_id: userId,
                    delta: delta,
                    // ** ุงุฑุณุงู ุณุงู ู ูุงู ุจู API **
                    year: currentYear,
                    month: currentMonth
                })
            })
            .then(response => {
                if (!response.ok) {
                    buttonsInCell.forEach(btn => btn.disabled = false);
                    return response.json().then(data => {
                        throw new Error(data.detail || response.statusText || 'ุฎุทุง ุฏุฑ ุชูุธู ุงูุชุงุฒ.');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log("Adjustment successful:", data);

                const adjustmentValueSpan = adjustmentCell.querySelector('.board-adjustment-value');
                const totalMonthlyScoreCell = row.querySelector('.total-monthly-score');
                const totalMonthlyScoreAdjustedCell = row.querySelector('.total-monthly-score-adjusted');

                if (adjustmentValueSpan && totalMonthlyScoreCell && totalMonthlyScoreAdjustedCell) {
                    const currentTotalScore = new Decimal(totalMonthlyScoreCell.innerText);
                    const newAdjustment = new Decimal(data.new_adjustment_value);

                    adjustmentValueSpan.innerText = newAdjustment.toFixed(3);

                    const newAdjustedTotal = currentTotalScore.plus(newAdjustment);
                    totalMonthlyScoreAdjustedCell.innerText = newAdjustedTotal.toFixed(3);

                    buttonsInCell.forEach(btn => btn.disabled = false);
                } else {
                    console.error("Could not find required table cells to update.");
                }
            })
            .catch(error => {
                console.error("Error during adjustment:", error);
                alert("ุฎุทุง ุฏุฑ ุชูุธู ุงูุชุงุฒ: " + error.message);
                buttonsInCell.forEach(btn => btn.disabled = false);
            });
        });
    });
});
    </script>
{% endblock %}